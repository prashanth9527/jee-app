generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  phone             String?            @unique
  pendingPhone      String?
  emailVerified     Boolean            @default(false)
  phoneVerified     Boolean            @default(false)
  hashedPassword    String?
  fullName          String
  role              UserRole           @default(STUDENT)
  streamId          String?
  googleId          String?            @unique
  profilePicture    String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  trialStartedAt    DateTime?
  trialEndsAt       DateTime?
  aiTestsUsed       Int                @default(0)
  aiTestsLimit      Int                @default(0)
  lastAiResetAt     DateTime?
  createdExamPapers ExamPaper[]        @relation("ExamPaperCreator")
  examSubmissions   ExamSubmission[]
  otps              Otp[]
  paymentOrders     PaymentOrder[]
  createdQuestions  Question[]         @relation("QuestionCreator")
  reviewedReports   QuestionReport[]   @relation("ReportReviewer")
  questionReports   QuestionReport[]
  referralReceived  Referral?          @relation("Referee")
  referralsMade     Referral[]         @relation("Referrer")
  referralCode      ReferralCode?
  subscriptions     Subscription[]
  stream            Stream?            @relation(fields: [streamId], references: [id])
  blogBookmarks     BlogBookmark[]
  blogComments      BlogComment[]
  blogLikes         BlogLike[]
  blogs             Blog[]
  bookmarks         Bookmark[]
  contactTickets    ContactTicket[]
  lessonBadges      LessonBadge[]
  lessonProgress    LessonProgress[]
  lmsProgress       LMSProgress[]
  subjectProgress   SubjectProgress[]
  subtopicProgress  SubtopicProgress[]
  ticketResponses   TicketResponse[]
  topicProgress     TopicProgress[]
  sessions          UserSession[]
  performanceAnalysis ContentPerformanceAnalysis[]
  aiFeatureUsage     AIFeatureUsage[]
  aiGeneratedResults AIGeneratedResult[]
  aiContentGenerations AIContentGeneration[]
}

model Stream {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  code        String       @unique
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  subjects    Subject[]
  users       User[]
  blogs       Blog[]
  lmsContent  LMSContent[]
}

model Subject {
  id          String            @id @default(cuid())
  name        String
  description String?
  streamId    String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  lessons     Lesson[]
  questions   Question[]
  stream      Stream            @relation(fields: [streamId], references: [id], onDelete: Cascade)
  topics      Topic[]
  blogs       Blog[]
  lmsContent  LMSContent[]
  progress    SubjectProgress[]
  performanceAnalysis ContentPerformanceAnalysis[]

  @@unique([streamId, name])
}

model Lesson {
  id          String           @id @default(cuid())
  name        String
  description String?
  subjectId   String
  order       Int              @default(0)
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  subject     Subject          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions   Question[]
  topics      Topic[]
  progress    LessonProgress[]
  lmsContent  LMSContent[]
  aiContentGenerations AIContentGeneration[]

  @@unique([subjectId, name])
  @@unique([subjectId, order])
}

model Topic {
  id          String          @id @default(cuid())
  name        String
  description String?
  lessonId    String
  subjectId   String
  order       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  questions   Question[]
  subtopics   Subtopic[]
  lesson      Lesson          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  subject     Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  lmsContent  LMSContent[]
  progress    TopicProgress[]
  performanceAnalysis ContentPerformanceAnalysis[]
  aiContentGenerations AIContentGeneration[]

  @@unique([lessonId, name])
  @@unique([lessonId, order])
}

model Subtopic {
  id          String             @id @default(cuid())
  name        String
  description String?
  topicId     String
  order       Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  questions   Question[]
  topic       Topic              @relation(fields: [topicId], references: [id], onDelete: Cascade)
  lmsContent  LMSContent[]
  progress    SubtopicProgress[]
  performanceAnalysis ContentPerformanceAnalysis[]
  aiContentGenerations AIContentGeneration[]

  @@unique([topicId, name])
}

model Question {
  id                      String                           @id @default(cuid())
  stem                    String
  explanation             String?
  tip_formula             String?
  difficulty              Difficulty                       @default(MEDIUM)
  yearAppeared            Int?
  isPreviousYear          Boolean                          @default(false)
  isAIGenerated           Boolean                          @default(false)
  aiPrompt                String?
  section_name            String?
  subjectId               String?
  lessonId                String?
  topicId                 String?
  subtopicId              String?
  status                  QuestionStatus                   @default(underreview)
  pdfProcessorCacheId     String?
  createdAt               DateTime                         @default(now())
  updatedAt               DateTime                         @updatedAt
  createdById             String?
  formulaid               String?
  exerciseName            String?
  isOpenEnded             Boolean                          @default(false)
  correctNumericAnswer    Float?
  answerTolerance         Float?                           @default(0.01)
  answers                 ExamAnswer[]
  createdBy               User?                            @relation("QuestionCreator", fields: [createdById], references: [id])
  lesson                  Lesson?                          @relation(fields: [lessonId], references: [id])
  pdfProcessorCache       PDFProcessorCache?               @relation(fields: [pdfProcessorCacheId], references: [id])
  subject                 Subject?                         @relation(fields: [subjectId], references: [id])
  subtopic                Subtopic?                        @relation(fields: [subtopicId], references: [id])
  topic                   Topic?                           @relation(fields: [topicId], references: [id])
  formulas                Formula?                         @relation(fields: [formulaid], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "question_formulas_fk")
  alternativeExplanations QuestionAlternativeExplanation[]
  options                 QuestionOption[]
  reports                 QuestionReport[]
  tags                    QuestionTag[]
  bookmarks               Bookmark[]
}

model QuestionOption {
  id                String       @id @default(cuid())
  questionId        String
  text              String
  isCorrect         Boolean      @default(false)
  order             Int          @default(0)
  selectedByAnswers ExamAnswer[] @relation("SelectedOption")
  question          Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Tag {
  id        String        @id @default(cuid())
  name      String        @unique
  questions QuestionTag[]
}

model QuestionTag {
  questionId String
  tagId      String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([questionId, tagId])
}

model QuestionReport {
  id                     String                 @id @default(cuid())
  questionId             String
  userId                 String
  reportType             QuestionReportType
  reason                 String
  description            String?
  status                 ReportStatus           @default(PENDING)
  alternativeExplanation String?
  suggestedAnswer        String?
  reviewedById           String?
  reviewedAt             DateTime?
  reviewNotes            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  question               Question               @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reviewedBy             User?                  @relation("ReportReviewer", fields: [reviewedById], references: [id])
  user                   User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  suggestedOptions       QuestionReportOption[]
}

model QuestionReportOption {
  id        String         @id @default(cuid())
  reportId  String
  text      String
  isCorrect Boolean        @default(false)
  order     Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  report    QuestionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
}

model QuestionAlternativeExplanation {
  id          String   @id @default(cuid())
  questionId  String
  explanation String
  source      String
  reportId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model ExamPaper {
  id           String           @id @default(cuid())
  title        String
  description  String?
  subjectIds   String[]         @default([])
  topicIds     String[]         @default([])
  subtopicIds  String[]         @default([])
  questionIds  String[]         @default([])
  timeLimitMin Int?
  examType     ExamType         @default(REGULAR)
  contentId    String?          // For content-specific exams
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  createdById  String?
  createdBy    User?            @relation("ExamPaperCreator", fields: [createdById], references: [id])
  submissions  ExamSubmission[]
  content      LMSContent?      @relation(fields: [contentId], references: [id])
}

model ExamSubmission {
  id             String       @id @default(cuid())
  userId         String
  examPaperId    String
  startedAt      DateTime     @default(now())
  submittedAt    DateTime?
  totalQuestions Int
  correctCount   Int          @default(0)
  scorePercent   Float?
  answers        ExamAnswer[]
  examPaper      ExamPaper    @relation(fields: [examPaperId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ExamAnswer {
  id               String          @id @default(cuid())
  submissionId     String
  questionId       String
  selectedOptionId String?
  numericValue     Float?
  isCorrect        Boolean         @default(false)
  question         Question        @relation(fields: [questionId], references: [id])
  selectedOption   QuestionOption? @relation("SelectedOption", fields: [selectedOptionId], references: [id])
  submission       ExamSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId, questionId])
}

model Plan {
  id            String         @id @default(cuid())
  name          String         @unique
  description   String?
  priceCents    Int
  currency      String         @default("usd")
  interval      PlanInterval   @default(MONTH)
  planType      PlanType       @default(MANUAL)
  stripePriceId String?        @unique
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  paymentOrders PaymentOrder[]
  subscriptions Subscription[]
}

model Subscription {
  id               String             @id @default(cuid())
  userId           String
  planId           String
  status           SubscriptionStatus @default(ACTIVE)
  startedAt        DateTime           @default(now())
  endsAt           DateTime?
  stripeCustomerId String?
  stripeSubId      String?
  stripeStatus     String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  plan             Plan               @relation(fields: [planId], references: [id])
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PaymentOrder {
  id                 String             @id @default(cuid())
  userId             String
  planId             String
  merchantOrderId    String             @unique
  amount             Int
  currency           String             @default("INR")
  status             PaymentOrderStatus @default(PENDING)
  gateway            PaymentGateway
  gatewayOrderId     String?
  gatewayStatus      String?
  successUrl         String
  cancelUrl          String
  phonepeRedirectUrl String?
  phonepeDeepLink    String?
  stripeSessionId    String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  errorCode          String?
  errorDetails       String?
  errorMessage       String?
  initialResponse    String?
  statusResponse     String?
  webhookHeaders     String?
  webhookPayload     String?
  webhookProcessed   Boolean            @default(false)
  webhookProcessedAt DateTime?
  paymentLogs        PaymentLog[]
  plan               Plan               @relation(fields: [planId], references: [id])
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([merchantOrderId])
  @@index([gateway])
  @@index([status])
  @@index([webhookProcessed])
}

model PaymentLog {
  id               String         @id @default(cuid())
  paymentOrderId   String
  logType          PaymentLogType
  eventType        String?
  message          String
  data             String?
  requestUrl       String?
  requestMethod    String?
  requestHeaders   String?
  requestBody      String?
  responseStatus   Int?
  responseHeaders  String?
  responseBody     String?
  processingTimeMs Int?
  createdAt        DateTime       @default(now())
  paymentOrder     PaymentOrder   @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@index([paymentOrderId])
  @@index([logType])
  @@index([eventType])
  @@index([createdAt])
}

model Otp {
  id        String   @id @default(cuid())
  userId    String
  code      String
  type      OtpType
  target    String?
  expiresAt DateTime
  consumed  Boolean  @default(false)
  used      Boolean  @default(false)
  metadata  String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model ReferralCode {
  id         String     @id @default(cuid())
  userId     String     @unique
  code       String     @unique
  isActive   Boolean    @default(true)
  usageCount Int        @default(0)
  maxUsage   Int?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  referrals  Referral[]
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Referral {
  id             String           @id @default(cuid())
  referrerId     String
  refereeId      String           @unique
  referralCodeId String
  status         ReferralStatus   @default(PENDING)
  completedAt    DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  referee        User             @relation("Referee", fields: [refereeId], references: [id])
  referralCode   ReferralCode     @relation(fields: [referralCodeId], references: [id])
  referrer       User             @relation("Referrer", fields: [referrerId], references: [id])
  rewards        ReferralReward[]

  @@unique([referrerId, refereeId])
}

model ReferralReward {
  id          String     @id @default(cuid())
  referralId  String
  type        RewardType
  amount      Int
  currency    String?
  description String
  isClaimed   Boolean    @default(false)
  claimedAt   DateTime?
  expiresAt   DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  referral    Referral   @relation(fields: [referralId], references: [id])
}

model SystemSettings {
  id                 String   @id @default(cuid())
  siteTitle          String   @default("JEE App")
  siteDescription    String?
  siteKeywords       String?
  logoUrl            String?
  faviconUrl         String?
  ogImageUrl         String?
  contactEmail       String?
  supportEmail       String?
  privacyEmail       String?
  legalEmail         String?
  contactPhone       String?
  address            String?
  facebookUrl        String?
  twitterUrl         String?
  linkedinUrl        String?
  instagramUrl       String?
  youtubeUrl         String?
  googleAnalyticsId  String?
  facebookPixelId    String?
  customCss          String?
  customJs           String?
  maintenanceMode    Boolean  @default(false)
  maintenanceMessage String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  logoFooter         String?
  homeTemplate       String?  @default("default") @map("hometemplate") @db.VarChar(255)

  @@map("system_settings")
}

model Bookmark {
  id         String   @id @default(cuid())
  userId     String
  questionId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@map("bookmarks")
}

model Formula {
  id          String     @id @default(cuid())
  title       String
  formula     String
  description String?
  subject     String?
  tags        String[]   @default([])
  topicId     String?
  subtopicId  String?
  targetRole  UserRole   @default(STUDENT)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  Question    Question[]

  @@map("formulas")
}

model Notification {
  id         String               @id @default(cuid())
  title      String
  message    String?
  link       String?
  validFrom  DateTime
  validUntil DateTime
  isActive   Boolean              @default(true)
  priority   NotificationPriority @default(NORMAL)
  targetRole UserRole             @default(STUDENT)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt

  @@map("notifications")
}

model OAuthState {
  id          String   @id @default(cuid())
  state       String   @unique
  provider    String
  redirectUri String?
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@map("oauth_states")
}

model UserSession {
  id             String   @id @default(cuid())
  userId         String
  sessionId      String   @unique
  deviceInfo     String?
  ipAddress      String?
  userAgent      String?
  isActive       Boolean  @default(true)
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@map("user_sessions")
}

model ContactTicket {
  id        String           @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  status    TicketStatus     @default(OPEN)
  priority  TicketPriority   @default(NORMAL)
  category  TicketCategory   @default(GENERAL)
  userId    String?
  ipAddress String?
  userAgent String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User?            @relation(fields: [userId], references: [id])
  responses TicketResponse[]

  @@map("contact_tickets")
}

model TicketResponse {
  id          String        @id @default(cuid())
  ticketId    String
  message     String
  isInternal  Boolean       @default(false)
  responderId String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  responder   User          @relation(fields: [responderId], references: [id])
  ticket      ContactTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_responses")
}

model LMSContent {
  id               String        @id @default(cuid())
  title            String
  description      String?
  contentType      ContentType
  status           ContentStatus @default(DRAFT)
  accessType       AccessType    @default(FREE)
  contentData      Json?
  fileUrl          String?
  fileSize         Int?
  fileType         String?
  originalFileName String?
  externalUrl      String?
  iframeCode       String?
  youtubeId        String?
  youtubeUrl       String?
  h5pContent       Json?
  scormData        Json?
  contentSummary   String?       @db.Text
  mindMap          String?       @db.Text
  videoLink        String?
  streamId         String?
  subjectId        String?
  lessonId         String?
  topicId          String?
  subtopicId       String?
  isDripContent    Boolean       @default(false)
  dripDelay        Int?
  dripDate         DateTime?
  duration         Int?
  difficulty       Difficulty?
  tags             String[]
  order            Int           @default(0)
  parentId         String?
  views            Int           @default(0)
  completions      Int           @default(0)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  lesson           Lesson?       @relation(fields: [lessonId], references: [id])
  parent           LMSContent?   @relation("ContentHierarchy", fields: [parentId], references: [id])
  children         LMSContent[]  @relation("ContentHierarchy")
  stream           Stream?       @relation(fields: [streamId], references: [id])
  subject          Subject?      @relation(fields: [subjectId], references: [id])
  subtopic         Subtopic?     @relation(fields: [subtopicId], references: [id])
  topic            Topic?        @relation(fields: [topicId], references: [id])
  progress         LMSProgress[]
  pdfProcessorCache PDFProcessorCache[]
  exams            ExamPaper[]
  performanceAnalysis ContentPerformanceAnalysis[]
  aiFeatureUsage     AIFeatureUsage[]
  aiGeneratedResults AIGeneratedResult[]

  @@map("lms_content")
}

model LMSProgress {
  id             String         @id @default(cuid())
  userId         String
  contentId      String
  status         ProgressStatus @default(NOT_STARTED)
  progress       Float          @default(0)
  timeSpent      Int            @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  lastAccessedAt DateTime?
  score          Float?
  attempts       Int            @default(0)
  data           Json?
  content        LMSContent     @relation(fields: [contentId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentId])
  @@map("lms_progress")
}

model SubjectProgress {
  id               String         @id @default(cuid())
  userId           String
  subjectId        String
  status           ProgressStatus @default(NOT_STARTED)
  progress         Float          @default(0)
  timeSpent        Int            @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  lastAccessedAt   DateTime?
  lessonsCompleted Int            @default(0)
  totalLessons     Int            @default(0)
  contentCompleted Int            @default(0)
  totalContent     Int            @default(0)
  averageScore     Float?
  attempts         Int            @default(0)
  data             Json?
  subject          Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId])
  @@map("subject_progress")
}

model LessonProgress {
  id               String         @id @default(cuid())
  userId           String
  lessonId         String
  status           ProgressStatus @default(NOT_STARTED)
  progress         Float          @default(0)
  timeSpent        Int            @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  lastAccessedAt   DateTime?
  contentCompleted Int            @default(0)
  totalContent     Int            @default(0)
  topicsCompleted  Int            @default(0)
  totalTopics      Int            @default(0)
  averageScore     Float?
  attempts         Int            @default(0)
  data             Json?
  badges           LessonBadge[]
  lesson           Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

model TopicProgress {
  id                 String         @id @default(cuid())
  userId             String
  topicId            String
  status             ProgressStatus @default(NOT_STARTED)
  progress           Float          @default(0)
  timeSpent          Int            @default(0)
  startedAt          DateTime?
  completedAt        DateTime?
  lastAccessedAt     DateTime?
  contentCompleted   Int            @default(0)
  totalContent       Int            @default(0)
  subtopicsCompleted Int            @default(0)
  totalSubtopics     Int            @default(0)
  averageScore       Float?
  attempts           Int            @default(0)
  data               Json?
  topic              Topic          @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@map("topic_progress")
}

model SubtopicProgress {
  id               String         @id @default(cuid())
  userId           String
  subtopicId       String
  status           ProgressStatus @default(NOT_STARTED)
  progress         Float          @default(0)
  timeSpent        Int            @default(0)
  startedAt        DateTime?
  completedAt      DateTime?
  lastAccessedAt   DateTime?
  contentCompleted Int            @default(0)
  totalContent     Int            @default(0)
  averageScore     Float?
  attempts         Int            @default(0)
  data             Json?
  subtopic         Subtopic       @relation(fields: [subtopicId], references: [id], onDelete: Cascade)
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, subtopicId])
  @@map("subtopic_progress")
}

model LessonBadge {
  id             String         @id @default(cuid())
  userId         String
  lessonId       String
  badgeType      BadgeType
  title          String
  description    String?
  iconUrl        String?
  earnedAt       DateTime       @default(now())
  metadata       Json?
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress @relation(fields: [userId, lessonId], references: [userId, lessonId], onDelete: Cascade)

  @@unique([userId, lessonId, badgeType])
  @@map("lesson_badges")
}

model BlogCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  color       String?
  icon        String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  blogs       Blog[]

  @@map("blog_categories")
}

model Blog {
  id              String         @id @default(cuid())
  title           String
  slug            String         @unique
  excerpt         String?
  content         String
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  status          BlogStatus     @default(DRAFT)
  publishedAt     DateTime?
  featuredImage   String?
  categoryId      String?
  tags            String[]
  authorId        String
  streamId        String?
  subjectId       String?
  viewCount       Int            @default(0)
  likeCount       Int            @default(0)
  shareCount      Int            @default(0)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  featured        Boolean        @default(false)
  bookmarks       BlogBookmark[]
  comments        BlogComment[]
  likes           BlogLike[]
  author          User           @relation(fields: [authorId], references: [id])
  category        BlogCategory?  @relation(fields: [categoryId], references: [id])
  stream          Stream?        @relation(fields: [streamId], references: [id])
  subject         Subject?       @relation(fields: [subjectId], references: [id])

  @@map("blogs")
}

model BlogComment {
  id          String        @id @default(cuid())
  content     String
  authorId    String
  blogId      String
  status      CommentStatus @default(PENDING)
  moderatedAt DateTime?
  moderatedBy String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  author      User          @relation(fields: [authorId], references: [id])
  blog        Blog          @relation(fields: [blogId], references: [id])

  @@map("blog_comments")
}

model BlogLike {
  id        String   @id @default(cuid())
  userId    String
  blogId    String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, blogId])
  @@map("blog_likes")
}

model BlogBookmark {
  id        String   @id @default(cuid())
  userId    String
  blogId    String
  createdAt DateTime @default(now())
  blog      Blog     @relation(fields: [blogId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, blogId])
  @@map("blog_bookmarks")
}

model WebhookLog {
  id               String    @id @default(cuid())
  gateway          String
  eventType        String?
  merchantOrderId  String?
  payload          Json
  headers          Json?
  rawBody          String?
  processed        Boolean   @default(false)
  processedAt      DateTime?
  processingTimeMs Int?
  response         Json?
  statusCode       Int?
  error            String?
  retryCount       Int       @default(0)
  receivedAt       DateTime  @default(now())
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("webhook_logs")
}

model PDFProcessorCache {
  id               String            @id @default(cuid())
  fileName         String            @unique
  filePath         String
  fileSize         Int
  recordType       RecordType        @default(pyq)
  chatGptFileId    String?
  processingStatus ProcessingStatus  @default(PENDING)
  systemPrompt     String?
  userPrompt       String?
  responseData     Json?
  processedData    Json?
  jsonContent      String?
  outputFilePath   String?
  latexContent     String?
  latexFilePath    String?
  zipFilePath      String?
  pdfFilePath      String?
  errorMessage     String?
  processingTimeMs Int?
  retryCount       Int               @default(0)
  lastProcessedAt  DateTime?
  importedAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  htmlFilePath     String?
  htmlContent      String?
  lmsContentId     String?
  lmsContent       LMSContent? @relation(fields: [lmsContentId], references: [id])
  questions        Question[]
  logs             PDFProcessorLog[]

  @@map("pdf_processor_cache")
}

model PDFProcessorLog {
  id               String            @id @default(cuid())
  cacheId          String
  logType          LogType
  message          String
  data             Json?
  processingTimeMs Int?
  createdAt        DateTime          @default(now())
  cache            PDFProcessorCache @relation(fields: [cacheId], references: [id], onDelete: Cascade)

  @@map("pdf_processor_logs")
}

enum UserRole {
  ADMIN
  STUDENT
  EXPERT
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionReportType {
  INCORRECT_ANSWER
  INCORRECT_EXPLANATION
  SUGGESTED_EXPLANATION
  GRAMMATICAL_ERROR
  TECHNICAL_ERROR
  OTHER
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PlanType {
  MANUAL
  AI_ENABLED
}

enum PlanInterval {
  MONTH
  YEAR
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

enum PaymentGateway {
  STRIPE
  PHONEPE
}

enum PaymentOrderStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentLogType {
  INFO
  WARNING
  ERROR
  WEBHOOK
  API_CALL
  STATUS_UPDATE
}

enum OtpType {
  EMAIL
  PHONE
  EMAIL_CHANGE
  PHONE_CHANGE
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
  CANCELLED
}

enum RewardType {
  SUBSCRIPTION_DAYS
  MONETARY_CREDIT
  FEATURE_ACCESS
  DISCOUNT_PERCENT
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_USER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketCategory {
  GENERAL
  TECHNICAL_SUPPORT
  BILLING
  FEEDBACK
  PARTNERSHIP
  OTHER
}

enum ContentType {
  H5P
  SCORM
  FILE
  URL
  IFRAME
  YOUTUBE
  TEXT
  VIDEO
  AUDIO
  IMAGE
  QUIZ
  ASSIGNMENT
}

enum ContentStatus {
  DRAFT
  APPROVED
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

enum AccessType {
  FREE
  SUBSCRIPTION
  PREMIUM
  TRIAL
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  FAILED
  REVIEW
  REVISIT
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  SCHEDULED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
  SPAM
}

enum BadgeType {
  COMPLETION
  SPEED_DEMON
  PERFECT_SCORE
  PERSEVERANCE
  EARLY_BIRD
  NIGHT_OWL
  STREAK_MASTER
  TOP_PERFORMER
  CONTENT_EXPLORER
  QUIZ_MASTER
}

enum ProcessingStatus {
  PENDING
  UPLOADING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum LogType {
  INFO
  WARNING
  ERROR
  SUCCESS
  API_CALL
  FILE_UPLOAD
  FILE_PROCESSING
  VALIDATION
}

enum QuestionStatus {
  approved
  underreview
  rejected
}

enum RecordType {
  pyq
  question
  lms
}

enum ExamType {
  REGULAR
  AI_EXAM
  CONTENT_EXAM
  PRACTICE_EXAM
  PYQ_PRACTICE
}

model ContentPerformanceAnalysis {
  id                String   @id @default(cuid())
  userId            String
  contentId         String
  subjectId         String?
  topicId           String?
  subtopicId        String?
  
  // Performance metrics
  timeSpent         Int      @default(0) // in seconds
  completionRate   Float    @default(0) // 0-100
  averageScore      Float?   // if applicable
  attempts          Int      @default(0)
  
  // AI analysis data
  strengths         String[] @default([])
  weaknesses        String[] @default([])
  suggestions       String[] @default([])
  difficultyLevel   String?  // AI assessed difficulty
  learningStyle    String?  // AI detected learning style
  
  // Analysis metadata
  lastAnalyzedAt    DateTime @default(now())
  analysisVersion   String   @default("1.0")
  aiModel           String   @default("gpt-4")
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content           LMSContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  subject           Subject? @relation(fields: [subjectId], references: [id])
  topic            Topic?   @relation(fields: [topicId], references: [id])
  subtopic          Subtopic? @relation(fields: [subtopicId], references: [id])
  
  @@unique([userId, contentId])
  @@map("content_performance_analysis")
}

model AIFeatureUsage {
  id                String   @id @default(cuid())
  userId            String
  contentId         String
  featureType       AIFeatureType
  usageCount        Int      @default(0)
  lastUsedAt        DateTime @default(now())
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content           LMSContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, contentId, featureType])
  @@map("ai_feature_usage")
}

model AIGeneratedResult {
  id                String   @id @default(cuid())
  userId            String
  contentId         String
  featureType       AIFeatureType
  resultData        Json     // Stores the generated content (questions, summary, etc.)
  version           Int      @default(1)
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content           LMSContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  
  @@unique([userId, contentId, featureType, version])
  @@map("ai_generated_results")
}

model AIContentGeneration {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Content identification
  lessonId  String?
  topicId   String?
  subtopicId String?
  
  // Content type and data
  contentType String // 'LESSON_SUMMARY', 'TOPIC_EXPLANATION', 'MICRO_LESSON'
  contentData Json   // The actual generated content
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  lesson    Lesson?    @relation(fields: [lessonId], references: [id])
  topic     Topic?     @relation(fields: [topicId], references: [id])
  subtopic  Subtopic?  @relation(fields: [subtopicId], references: [id])
  
  @@unique([userId, lessonId, contentType])
  @@unique([userId, topicId, contentType])
  @@unique([userId, subtopicId, contentType])
  @@map("ai_content_generations")
}

enum AIFeatureType {
  AI_QUESTIONS
  PERFORMANCE_ANALYSIS
  SUMMARY
  MINDMAP
  ANALYTICS_REFRESH
  LESSON_SUMMARY
  TOPIC_EXPLANATION
  MICRO_LESSON
}
